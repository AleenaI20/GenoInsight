<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenoInsight - Precision Medicine Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Simple Header -->
    <div class="gradient-bg text-white p-6 shadow-lg">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-4xl font-bold mb-2">üß¨ GenoInsight</h1>
            <p class="text-lg">Precision Medicine Platform - Identifying Health Risks & Treatment Recommendations</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-6">
        
        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex gap-4">
                <button onclick="showSection('upload')" id="btn-upload" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold">
                    üì§ Upload Patient Data
                </button>
                <button onclick="showSection('patients')" id="btn-patients" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold">
                    üë§ View Existing Patients
                </button>
                <button onclick="showSection('bulk')" id="btn-bulk" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold">
                    üìä Compare Multiple Patients
                </button>
            </div>
        </div>

        <!-- SECTION 1: UPLOAD VCF -->
        <div id="section-upload" class="section-content">
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Upload New Patient Genetic Data</h2>
                <p class="text-gray-600 mb-6">Upload a VCF file to analyze health risks and get treatment recommendations</p>
                
                <div class="border-4 border-dashed border-indigo-300 rounded-lg p-12 text-center bg-indigo-50">
                    <div class="text-6xl mb-4">üìÅ</div>
                    <p class="text-xl font-semibold text-gray-700 mb-2">Select VCF File</p>
                    <input type="file" id="vcfFile" accept=".vcf,.vcf.gz" class="hidden">
                    <button onclick="document.getElementById('vcfFile').click()" class="mt-4 bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 font-semibold text-lg">
                        Choose File
                    </button>
                    <p class="text-sm text-gray-500 mt-3" id="fileName"></p>
                </div>

                <div id="uploadResults" class="mt-8" style="display:none;"></div>
            </div>
        </div>

        <!-- SECTION 2: VIEW PATIENTS -->
        <div id="section-patients" class="section-content" style="display:none;">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Select a Patient</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="patientGrid"></div>
            </div>

            <div id="patientResults" style="display:none;"></div>
        </div>

        <!-- SECTION 3: BULK ANALYSIS -->
        <div id="section-bulk" class="section-content" style="display:none;">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Compare Multiple Patients</h2>
                <p class="text-gray-600 mb-4">Select patients to compare their health risks side-by-side</p>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6" id="bulkSelection"></div>
                
                <button onclick="runBulkAnalysis()" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 font-semibold text-lg">
                    Compare Selected Patients
                </button>

                <div id="bulkResults" class="mt-8" style="display:none;"></div>
            </div>
        </div>

    </div>

    <script>
        let allPatients = [];

        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(s => s.style.display = 'none');
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById('section-' + section).style.display = 'block';
            document.getElementById('btn-' + section).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('btn-' + section).classList.add('bg-indigo-600', 'text-white');

            if (section === 'patients') loadPatients();
            if (section === 'bulk') loadBulkOptions();
        }

        // VCF Upload
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('vcfFile').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                document.getElementById('fileName').textContent = `Selected: ${file.name}`;
                
                const formData = new FormData();
                formData.append('file', file);

                const resultsDiv = document.getElementById('uploadResults');
                resultsDiv.innerHTML = '<div class="text-center py-8"><div class="text-4xl mb-4">‚è≥</div><p class="text-lg font-semibold">Analyzing genetic data...</p></div>';
                resultsDiv.style.display = 'block';

                try {
                    const response = await fetch('/api/upload/vcf', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    if (data.success) {
                        displaySimpleResults(data, 'upload');
                    } else {
                        resultsDiv.innerHTML = `<div class="bg-red-100 border-2 border-red-400 rounded-lg p-6"><p class="text-red-800 font-semibold">Error: ${data.error}</p></div>`;
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="bg-red-100 border-2 border-red-400 rounded-lg p-6"><p class="text-red-800 font-semibold">Error: ${error.message}</p></div>`;
                }
            });
        });

        // Load patients
        async function loadPatients() {
            const response = await fetch('/api/patients');
            allPatients = await response.json();
            
            const grid = document.getElementById('patientGrid');
            grid.innerHTML = allPatients.map(p => `
                <button onclick="selectPatient('${p.id}')" class="p-4 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:shadow-lg text-left transition-all">
                    <p class="font-bold text-gray-800">${p.name}</p>
                    <p class="text-sm text-gray-600">${p.id} - Age ${p.age}</p>
                    <p class="text-sm text-gray-600">${p.ancestry}</p>
                </button>
            `).join('');
        }

        async function selectPatient(patientId) {
            const response = await fetch(`/api/patient/${patientId}/variants`);
            const data = await response.json();
            displaySimpleResults(data, 'patient');
        }

        function displaySimpleResults(data, source) {
            const targetDiv = source === 'upload' ? 'uploadResults' : 'patientResults';
            const resultsDiv = document.getElementById(targetDiv);
            
            const variants = data.variants;
            const patient = source === 'upload' ? {name: 'New Patient'} : data.patient;
            
            const pathogenic = variants.filter(v => v.pathogenicity === 'Pathogenic' || v.pathogenicity === 'Risk Factor');
            
            const riskLevel = pathogenic.length > 5 ? 'HIGH' : pathogenic.length > 2 ? 'MODERATE' : 'LOW';
            const riskColor = riskLevel === 'HIGH' ? 'red' : riskLevel === 'MODERATE' ? 'orange' : 'green';

            resultsDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Analysis Results: ${patient.name}</h2>
                    
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="bg-${riskColor}-50 border-2 border-${riskColor}-400 rounded-lg p-6 text-center">
                            <p class="text-sm text-${riskColor}-700 mb-2">OVERALL HEALTH RISK</p>
                            <p class="text-5xl font-bold text-${riskColor}-700">${riskLevel}</p>
                            <p class="text-sm text-${riskColor}-600 mt-2">${pathogenic.length} condition${pathogenic.length !== 1 ? 's' : ''} identified</p>
                        </div>
                        
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
                            <p class="text-sm text-blue-700 mb-3 font-semibold">WHAT THIS MEANS</p>
                            ${riskLevel === 'HIGH' ? 
                                '<p class="text-sm text-gray-700">Multiple genetic health risks detected. Immediate consultation with a genetic counselor recommended.</p>' :
                             riskLevel === 'MODERATE' ?
                                '<p class="text-sm text-gray-700">Some genetic health risks detected. Schedule an appointment with your healthcare provider to discuss screening and prevention.</p>' :
                                '<p class="text-sm text-gray-700">No significant genetic health risks detected at this time. Continue regular health check-ups.</p>'
                            }
                        </div>
                    </div>
                </div>

                ${pathogenic.length > 0 ? `
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-xl font-bold text-red-700 mb-4">‚ö†Ô∏è Identified Health Conditions & Action Plan</h3>
                    <div class="space-y-6">
                        ${pathogenic.map(v => `
                            <div class="border-2 border-red-300 bg-red-50 p-6 rounded-lg">
                                <div class="mb-4">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <p class="font-bold text-2xl text-gray-800 mb-2">${v.disease}</p>
                                            <p class="text-sm text-gray-700"><strong>Affected Gene:</strong> ${v.gene} (Variant: ${v.id})</p>
                                            <p class="text-sm text-gray-600 mt-1"><strong>Inheritance:</strong> ${v.inheritance || 'Genetic'}</p>
                                        </div>
                                        <div class="ml-4">
                                            <div class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-center text-sm">
                                                ${v.pathogenicity}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${v.treatment_plan ? `
                                <div class="border-t-2 border-red-300 pt-4 mt-4">
                                    <p class="font-bold text-lg text-gray-800 mb-3">üìã Recommended Action Plan:</p>
                                    
                                    <div class="space-y-3">
                                        <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                                            <p class="font-bold text-blue-800 mb-2">üíä Treatment Options</p>
                                            <p class="text-sm text-gray-700">${v.treatment_plan.treatment}</p>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg border-l-4 border-green-500">
                                            <p class="font-bold text-green-800 mb-2">üîç Screening & Testing</p>
                                            <p class="text-sm text-gray-700">${v.treatment_plan.screening}</p>
                                        </div>
                                        <div class="bg-white p-4 rounded-lg border-l-4 border-orange-500">
                                            <p class="font-bold text-orange-800 mb-2">üõ°Ô∏è Prevention Strategies</p>
                                            <p class="text-sm text-gray-700">${v.treatment_plan.prevention}</p>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="bg-green-50 border-2 border-green-400 rounded-lg p-6 mb-6">
                    <div class="flex items-center gap-4">
                        <div class="text-5xl">‚úÖ</div>
                        <div>
                            <p class="text-green-800 font-bold text-xl mb-2">No Significant Health Risks Detected</p>
                            <p class="text-green-700">Based on current genetic analysis, no pathogenic variants were found.</p>
                        </div>
                    </div>
                </div>
                `}
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Bulk Analysis
        function loadBulkOptions() {
            const grid = document.getElementById('bulkSelection');
            grid.innerHTML = allPatients.length === 0 ? '<p class="col-span-3 text-gray-600">Loading patients...</p>' : allPatients.map(p => `
                <label class="flex items-center p-3 border-2 border-gray-300 rounded-lg hover:border-indigo-400 cursor-pointer">
                    <input type="checkbox" class="bulk-checkbox mr-3 w-5 h-5" value="${p.id}">
                    <div>
                        <p class="font-semibold">${p.name}</p>
                        <p class="text-xs text-gray-600">${p.id} - ${p.ancestry}</p>
                    </div>
                </label>
            `).join('');
            
            if (allPatients.length === 0) {
                loadPatients().then(() => loadBulkOptions());
            }
        }

        async function runBulkAnalysis() {
            const checkboxes = document.querySelectorAll('.bulk-checkbox:checked');
            const patientIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (patientIds.length === 0) {
                alert('Please select at least one patient');
                return;
            }

            const response = await fetch('/api/bulk/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({patients: patientIds})
            });
            
            const data = await response.json();
            
            const resultsDiv = document.getElementById('bulkResults');
            resultsDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Patient Comparison Results</h3>
                    
                    <div class="space-y-6">
                        ${data.results.map(r => {
                            const riskLevel = r.pathogenicVariants > 5 ? 'HIGH' : r.pathogenicVariants > 2 ? 'MODERATE' : 'LOW';
                            const riskColor = riskLevel === 'HIGH' ? 'red' : riskLevel === 'MODERATE' ? 'orange' : 'green';
                            return `
                            <div class="border-2 border-gray-300 rounded-lg p-6">
                                <!-- Patient Header -->
                                <div class="flex items-center justify-between mb-4 pb-4 border-b-2">
                                    <div>
                                        <p class="font-bold text-2xl text-gray-800">${r.name}</p>
                                        <p class="text-gray-600">ID: ${r.patient_id} | Age: ${r.age} | ${r.ancestry}</p>
                                    </div>
                                    <div class="bg-${riskColor}-100 border-2 border-${riskColor}-400 px-6 py-3 rounded-lg">
                                        <p class="text-sm text-${riskColor}-700">RISK LEVEL</p>
                                        <p class="text-3xl font-bold text-${riskColor}-700">${riskLevel}</p>
                                    </div>
                                </div>

                                <!-- Conditions and Treatments -->
                                ${r.conditions.length > 0 ? `
                                    <div class="space-y-3">
                                        <p class="font-bold text-lg text-gray-800">${r.pathogenicVariants} Health Condition${r.pathogenicVariants > 1 ? 's' : ''} Identified:</p>
                                        ${r.conditions.map(c => `
                                            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                                                <p class="font-bold text-gray-800 mb-1">${c.disease}</p>
                                                <p class="text-sm text-gray-700 mb-2"><strong>Gene:</strong> ${c.gene} (${c.variant})</p>
                                                ${c.treatment ? `
                                                    <div class="bg-white p-3 rounded mt-2">
                                                        <p class="text-xs text-blue-700 font-semibold mb-1">üíä TREATMENT</p>
                                                        <p class="text-sm text-gray-700">${c.treatment}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-green-700 font-semibold">‚úÖ No significant health risks detected</p>'}
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        // Initialize
        if (allPatients.length === 0) {
            fetch('/api/patients').then(r => r.json()).then(patients => {
                allPatients = patients;
            });
        }
    </script>
</body>
</html>