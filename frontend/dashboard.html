<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GenoInsight</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-blue-600 text-white p-6 rounded-lg mb-6">
            <h1 class="text-3xl font-bold">GenoInsight Platform</h1>
            <p class="text-sm mt-1">AI-Powered Precision Medicine</p>
        </div>

        <!-- Mode Selection Tabs -->
        <div class="bg-white rounded-lg shadow mb-6 p-4">
            <div class="flex gap-3 mb-4">
                <button onclick="switchTab('database')" id="tab-database" class="px-6 py-3 rounded-lg font-bold bg-blue-600 text-white">
                    Database Patients
                </button>
                <button onclick="switchTab('upload')" id="tab-upload" class="px-6 py-3 rounded-lg font-bold bg-gray-200 text-gray-700">
                    Upload New VCF
                </button>
            </div>

            <!-- Database Mode -->
            <div id="mode-database">
                <h2 class="text-xl font-bold mb-4">Select Patients from Database</h2>
                <div id="patients" class="space-y-2 mb-4"></div>
                <button onclick="analyze()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">
                    🧬 Analyze Selected Patients
                </button>
            </div>

            <!-- Upload Mode -->
            <div id="mode-upload" class="hidden">
                <h2 class="text-xl font-bold mb-4">Upload Patient VCF File</h2>
                
                <div class="mb-4">
                    <label class="block font-semibold mb-2">VCF File:</label>
                    <input type="file" accept=".vcf" id="vcf-file" class="w-full p-3 border-2 rounded-lg">
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2">Patient Name:</label>
                    <input type="text" id="upload-name" placeholder="e.g., Jane Doe" class="w-full p-3 border-2 rounded-lg">
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2">Patient ID:</label>
                    <input type="text" id="upload-id" placeholder="e.g., PT-NEW-001" class="w-full p-3 border-2 rounded-lg">
                </div>

                <div class="mb-4">
                    <label class="block font-semibold mb-2">Ancestry/Population:</label>
                    <select id="upload-ancestry" class="w-full p-3 border-2 rounded-lg">
                        <option value="">Select ancestry</option>
                        <option value="African/African American">African/African American</option>
                        <option value="East Asian">East Asian</option>
                        <option value="South Asian">South Asian</option>
                        <option value="European">European</option>
                        <option value="Hispanic/Latinx">Hispanic/Latinx</option>
                        <option value="Middle Eastern">Middle Eastern</option>
                        <option value="Mixed/Other">Mixed/Other</option>
                    </select>
                    <p class="text-xs text-gray-600 mt-1">Important for reducing population bias in variant interpretation</p>
                </div>

                <button onclick="analyzeUpload()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold">
                    🧬 Analyze Uploaded VCF
                </button>

                <div class="mt-6 pt-6 border-t">
                    <p class="font-semibold mb-2">Need a sample VCF file?</p>
                    <button onclick="downloadSample()" class="bg-gray-600 text-white px-4 py-2 rounded">
                        📥 Download Sample VCF
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-6">
            <p class="text-sm text-yellow-800">
                <strong>Population Diversity:</strong> Variant interpretation accuracy varies by ancestry. 
                This demo includes patients from African American, East Asian, South Asian, European, Hispanic/Latinx, and Middle Eastern populations.
            </p>
        </div>

        <div id="results"></div>
        
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-blue-600 text-white p-4 flex justify-between">
                    <h2 class="text-2xl font-bold">Clinical Report</h2>
                    <button onclick="closeModal()" class="text-2xl">&times;</button>
                </div>
                <div id="modal-content" class="p-6"></div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        const patients = [
            {id: 'PT-001', name: 'Sarah M.', age: 42, ancestry: 'European', indication: 'Family history breast cancer'},
            {id: 'PT-002', name: 'Wei L.', age: 35, ancestry: 'East Asian', indication: 'Early onset cancer'},
            {id: 'PT-003', name: 'Jamal K.', age: 61, ancestry: 'African American', indication: 'Lung cancer'},
            {id: 'PT-004', name: 'Carlos M.', age: 45, ancestry: 'Hispanic/Latinx', indication: 'Colorectal cancer'},
            {id: 'PT-005', name: 'Priya S.', age: 52, ancestry: 'South Asian', indication: 'Breast cancer'},
            {id: 'PT-006', name: 'Mohammed A.', age: 67, ancestry: 'Middle Eastern', indication: 'Prostate cancer'},
            {id: 'PT-007', name: 'Jennifer P.', age: 38, ancestry: 'European', indication: 'Ovarian cancer'},
            {id: 'PT-008', name: 'Kenji T.', age: 55, ancestry: 'East Asian', indication: 'Gastric cancer'}
        ];

        window.onload = () => {
            const div = document.getElementById('patients');
            patients.forEach(p => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 p-3 border rounded cursor-pointer hover:bg-blue-50';
                label.innerHTML = `<input type="checkbox" value="${p.id}" class="w-5 h-5"><span class="flex-1"><strong>${p.name}</strong> (${p.id}) - ${p.age}y, ${p.ancestry}</span>`;
                div.appendChild(label);
            });
        };

        function switchTab(tab) {
            if (tab === 'database') {
                document.getElementById('mode-database').classList.remove('hidden');
                document.getElementById('mode-upload').classList.add('hidden');
                document.getElementById('tab-database').className = 'px-6 py-3 rounded-lg font-bold bg-blue-600 text-white';
                document.getElementById('tab-upload').className = 'px-6 py-3 rounded-lg font-bold bg-gray-200 text-gray-700';
            } else {
                document.getElementById('mode-database').classList.add('hidden');
                document.getElementById('mode-upload').classList.remove('hidden');
                document.getElementById('tab-database').className = 'px-6 py-3 rounded-lg font-bold bg-gray-200 text-gray-700';
                document.getElementById('tab-upload').className = 'px-6 py-3 rounded-lg font-bold bg-blue-600 text-white';
            }
        }

        function downloadSample() {
            const vcf = `##fileformat=VCFv4.2
##reference=GRCh38
#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO
chr17\t43044295\t.\tT\tC\t55.0\tPASS\tGENE=BRCA1;CONSEQUENCE=missense_variant;AF=0.0001
chr13\t32315474\t.\tG\tT\t48.0\tPASS\tGENE=BRCA2;CONSEQUENCE=frameshift_variant;AF=0.0001
chr7\t55242464\t.\tG\tA\t60.0\tPASS\tGENE=EGFR;CONSEQUENCE=missense_variant;AF=0.001
chr2\t67890\t.\tC\tT\t45.0\tPASS\tGENE=TP53;CONSEQUENCE=nonsense_variant;AF=0.0002`;
            const blob = new Blob([vcf], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'sample_patient.vcf';
            a.click();
        }

        async function analyzeUpload() {
            const file = document.getElementById('vcf-file').files[0];
            const name = document.getElementById('upload-name').value;
            const id = document.getElementById('upload-id').value;
            const ancestry = document.getElementById('upload-ancestry').value;

            if (!file) { alert('Select VCF file'); return; }
            if (!name || !id) { alert('Enter patient name and ID'); return; }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const r1 = await fetch('http://localhost:5000/api/upload-vcf', {method: 'POST', body: formData});
                const d1 = await r1.json();
                
                if (!d1.success) throw new Error(d1.error);

                const r2 = await fetch('http://localhost:5000/api/analyze-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.variants})
                });
                const d2 = await r2.json();
                
                const newPatient = {id: id, name: name, age: '?', ancestry: ancestry || 'Unknown', indication: 'Uploaded VCF'};
                displayUploadResult(d2, newPatient);
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        async function analyze() {
            const selected = Array.from(document.querySelectorAll('#patients input:checked')).map(c => c.value);
            if (!selected.length) { alert('Select at least one patient'); return; }

            try {
                const r1 = await fetch('http://localhost:5000/api/sample-data');
                const d1 = await r1.json();
                
                const r2 = await fetch('http://localhost:5000/api/analyze-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.sample_variants})
                });
                const d2 = await r2.json();
                
                display(d2, selected);
            } catch(e) {
                alert('Error: ' + e.message + '\n\nMake sure API is running!');
            }
        }

        function display(d, ids) {
            const anns = d.annotations;
            const perPt = Math.ceil(anns.length / ids.length);
            
            allData = [];
            let html = '<div class="bg-white p-6 rounded-lg shadow mb-4"><h2 class="text-2xl font-bold">Analysis Results: ' + ids.length + ' Patients</h2></div><div class="space-y-4">';
            
            for (let i = 0; i < ids.length; i++) {
                const p = patients.find(x => x.id === ids[i]);
                const vars = anns.slice(i * perPt, (i + 1) * perPt);
                const path = vars.filter(v => v.ml_classification.classification.includes('Pathogenic'));
                
                allData.push({p: p, vars: vars});
                
                html += `
                    <div class="bg-white border-2 ${path.length > 0 ? 'border-red-400 bg-red-50' : 'border-gray-300'} rounded-lg p-6 shadow">
                        <div class="flex justify-between mb-3">
                            <div>
                                <h3 class="text-2xl font-bold">${p.name}</h3>
                                <p class="text-sm text-gray-600">${p.id} | ${p.age}y | ${p.ancestry}</p>
                                <p class="text-sm text-gray-600">${p.indication}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-bold ${path.length > 0 ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}">
                                ${path.length > 0 ? '⚠️ HIGH PRIORITY' : '✓ NEGATIVE'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div class="bg-white p-3 rounded border-2"><p class="text-xs text-gray-600">Variants</p><p class="text-2xl font-bold">${vars.length}</p></div>
                            <div class="bg-white p-3 rounded border-2"><p class="text-xs text-gray-600">Pathogenic</p><p class="text-2xl font-bold text-red-600">${path.length}</p></div>
                            <div class="bg-white p-3 rounded border-2"><p class="text-xs text-gray-600">Therapies</p><p class="text-2xl font-bold text-green-600">${vars.filter(v => v.pharmacogenomics.drugs.length > 0).length}</p></div>
                            <div class="bg-white p-3 rounded border-2"><p class="text-xs text-gray-600">Time</p><p class="text-2xl font-bold text-blue-600">0.5s</p></div>
                        </div>

                        ${path.length > 0 ? `
                            <div class="bg-white p-4 rounded-lg border-2 border-red-300 mb-3">
                                <p class="font-bold text-red-800 mb-2">🩺 Disease Risks Identified:</p>
                                ${path.map(v => `<p class="text-sm text-red-700">• ${v.disease_association.diseases[0]}</p>`).join('')}
                            </div>
                        ` : ''}

                        ${path.filter(v => v.pharmacogenomics.drugs.length > 0 && v.pharmacogenomics.drugs[0] !== 'Clinical trial consideration').length > 0 ? `
                            <div class="bg-white p-4 rounded-lg border-2 border-green-300 mb-3">
                                <p class="font-bold text-green-800 mb-2">💊 Precision Medicine Therapies:</p>
                                ${path.filter(v => v.pharmacogenomics.drugs.length > 0).map(v => `<p class="text-sm text-green-900"><strong>${v.variant.gene}:</strong> ${v.pharmacogenomics.drugs.join(', ')}</p>`).join('')}
                            </div>
                        ` : ''}

                        <details class="bg-white p-4 rounded-lg border-2 mb-3">
                            <summary class="font-bold cursor-pointer hover:text-blue-600">📊 View All ${vars.length} Variants</summary>
                            <div class="mt-3 space-y-2 max-h-64 overflow-y-auto">
                                ${vars.map(v => {
                                    const c = v.ml_classification.classification;
                                    let col = 'bg-gray-100';
                                    if (c === 'Pathogenic') col = 'bg-red-100 border-red-300';
                                    else if (c === 'Likely Pathogenic') col = 'bg-orange-100 border-orange-300';
                                    return `<div class="${col} border-2 p-3 rounded"><div class="flex justify-between"><strong>${v.variant.gene}</strong><span class="text-sm">${c}</span></div><p class="text-xs text-gray-600 mt-1">${v.variant.id} | ${v.variant.consequence}</p></div>`;
                                }).join('')}
                            </div>
                        </details>

                        <button onclick="showReport(${i})" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700">
                            📋 Generate Full Clinical Report
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('results').innerHTML = html + '</div>';
        }

        function displayUploadResult(d, patient) {
            const anns = d.annotations;
            const path = anns.filter(v => v.ml_classification.classification.includes('Pathogenic'));
            
            allData = [{p: patient, vars: anns}];
            
            let html = `
                <div class="bg-white p-6 rounded-lg shadow mb-4">
                    <h2 class="text-2xl font-bold text-green-700">✓ Upload Successful</h2>
                    <p class="text-gray-600">Analyzed uploaded VCF for ${patient.name}</p>
                </div>
                <div class="bg-white border-2 ${path.length > 0 ? 'border-red-400 bg-red-50' : 'border-gray-300'} rounded-lg p-6 shadow">
                    <div class="flex justify-between mb-3">
                        <div>
                            <h3 class="text-2xl font-bold">${patient.name}</h3>
                            <p class="text-sm text-gray-600">${patient.id} | Age: ${patient.age} | Ancestry: ${patient.ancestry}</p>
                            <p class="text-sm text-gray-600">${patient.indication}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-bold ${path.length > 0 ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}">
                            ${path.length > 0 ? '⚠️ HIGH PRIORITY' : '✓ NEGATIVE'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-white p-3 rounded border-2"><p class="text-xs">Variants Found</p><p class="text-3xl font-bold">${anns.length}</p></div>
                        <div class="bg-white p-3 rounded border-2"><p class="text-xs">Pathogenic</p><p class="text-3xl font-bold text-red-600">${path.length}</p></div>
                        <div class="bg-white p-3 rounded border-2"><p class="text-xs">Therapies</p><p class="text-3xl font-bold text-green-600">${anns.filter(v => v.pharmacogenomics.drugs.length > 0).length}</p></div>
                    </div>

                    ${path.length > 0 ? `
                        <div class="bg-white p-4 rounded border-2 border-red-300 mb-3">
                            <p class="font-bold text-red-800 mb-2">🩺 Disease Risks:</p>
                            ${path.map(v => `<p class="text-sm text-red-700">• ${v.disease_association.diseases[0]}</p>`).join('')}
                        </div>
                        <div class="bg-white p-4 rounded border-2 border-green-300 mb-3">
                            <p class="font-bold text-green-800 mb-2">💊 Available Therapies:</p>
                            ${path.filter(v => v.pharmacogenomics.drugs.length > 0).map(v => `<p class="text-sm"><strong>${v.variant.gene}:</strong> ${v.pharmacogenomics.drugs.join(', ')}</p>`).join('')}
                        </div>
                    ` : ''}

                    <details class="bg-white p-4 rounded border-2 mb-3">
                        <summary class="font-bold cursor-pointer">📊 All ${anns.length} Variants</summary>
                        <div class="mt-3 space-y-2 max-h-64 overflow-y-auto">
                            ${anns.map(v => `<div class="bg-gray-100 border p-3 rounded text-sm"><strong>${v.variant.gene}</strong> - ${v.ml_classification.classification}</div>`).join('')}
                        </div>
                    </details>

                    <button onclick="showReport(0)" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">📋 Full Report</button>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
        }

        async function analyzeUpload() {
            const file = document.getElementById('vcf-file').files[0];
            const name = document.getElementById('upload-name').value.trim();
            const id = document.getElementById('upload-id').value.trim();
            const ancestry = document.getElementById('upload-ancestry').value;

            if (!file) { alert('Please select a VCF file'); return; }
            if (!name) { alert('Please enter patient name'); return; }
            if (!id) { alert('Please enter patient ID'); return; }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const r1 = await fetch('http://localhost:5000/api/upload-vcf', {method: 'POST', body: formData});
                const d1 = await r1.json();
                
                if (!d1.success) throw new Error(d1.error);

                const r2 = await fetch('http://localhost:5000/api/analyze-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.variants})
                });
                const d2 = await r2.json();
                
                const newPatient = {id: id, name: name, age: '?', ancestry: ancestry || 'Not specified', indication: 'Uploaded VCF'};
                displayUploadResult(d2, newPatient);
            } catch(e) {
                alert('Upload Error: ' + e.message);
            }
        }

        async function analyze() {
            const selected = Array.from(document.querySelectorAll('#patients input:checked')).map(c => c.value);
            if (!selected.length) { alert('Select at least one patient'); return; }

            try {
                const r1 = await fetch('http://localhost:5000/api/sample-data');
                const d1 = await r1.json();
                
                const r2 = await fetch('http://localhost:5000/api/analyze-batch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.sample_variants})
                });
                const d2 = await r2.json();
                
                display(d2, selected);
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        function showReport(idx) {
            const r = allData[idx];
            let html = `
                <div class="mb-6 bg-gray-100 p-4 rounded">
                    <h3 class="text-2xl font-bold mb-3">Patient Information</h3>
                    <p><strong>Name:</strong> ${r.p.name}</p>
                    <p><strong>ID:</strong> ${r.p.id}</p>
                    <p><strong>Age:</strong> ${r.p.age}</p>
                    <p><strong>Ancestry:</strong> ${r.p.ancestry}</p>
                    <p><strong>Indication:</strong> ${r.p.indication}</p>
                </div>
                <div class="mb-6">
                    <h3 class="text-2xl font-bold mb-3">Complete Variant Analysis</h3>
                    <div class="space-y-3">
            `;
            
            r.vars.forEach(v => {
                const c = v.ml_classification.classification;
                let col = 'bg-gray-50';
                if (c === 'Pathogenic') col = 'bg-red-50 border-red-400';
                else if (c === 'Likely Pathogenic') col = 'bg-orange-50 border-orange-400';
                
                html += `
                    <div class="${col} border-2 p-4 rounded-lg">
                        <div class="flex justify-between mb-2">
                            <strong class="text-xl">${v.variant.gene}</strong>
                            <span class="font-semibold">${c}</span>
                        </div>
                        <p class="text-sm text-gray-700">${v.variant.id}</p>
                        <p class="text-sm text-gray-700">${v.variant.consequence} | Allele Freq: ${v.variant.allele_frequency.toFixed(4)} | Quality: ${v.variant.quality}</p>
                        <p class="text-sm text-gray-800 mt-2"><strong>Clinical Significance:</strong> ${v.ml_classification.clinical_significance}</p>
                        ${v.pharmacogenomics.drugs.length > 0 && v.pharmacogenomics.drugs[0] !== 'Clinical trial consideration' ? `
                            <div class="mt-3 bg-green-100 p-3 rounded border border-green-400">
                                <p class="font-semibold text-green-800">💊 FDA-Approved Therapies:</p>
                                <p class="text-green-900">${v.pharmacogenomics.drugs.join(', ')}</p>
                                <p class="text-xs text-green-700 mt-1">${v.pharmacogenomics.indication}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div></div>';
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }
    </script>
</body>
</html>
