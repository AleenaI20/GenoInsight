<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenoInsight</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen">
    <div class="container mx-auto p-6">
        <header class="mb-8 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-xl p-6 text-white">
            <h1 class="text-4xl font-bold">GenoInsight</h1>
            <p class="text-lg mt-2">AI-Powered Precision Medicine</p>
        </header>

        <div class="bg-white rounded-lg shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Analysis Options</h2>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button onclick="showMode('upload')" class="p-6 border-2 rounded-lg hover:bg-blue-50">
                    <div class="text-4xl mb-2">📤</div>
                    <h3 class="font-bold">Upload VCF</h3>
                </button>
                
                <button onclick="showMode('single')" class="p-6 border-2 rounded-lg hover:bg-green-50">
                    <div class="text-4xl mb-2">👤</div>
                    <h3 class="font-bold">Single Patient</h3>
                </button>
                
                <button onclick="showMode('batch')" class="p-6 border-2 rounded-lg hover:bg-purple-50">
                    <div class="text-4xl mb-2">👥</div>
                    <h3 class="font-bold">Batch</h3>
                </button>
            </div>

            <div id="upload-mode" class="hidden bg-blue-50 p-6 rounded-lg">
                <input type="file" accept=".vcf" id="vcf-upload" class="w-full p-3 border-2 rounded mb-3">
                <input type="text" id="patient-name" placeholder="Patient Name" class="w-full p-2 border rounded mb-3">
                <button onclick="analyzeUpload()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold">🧬 Analyze</button>
                <div class="mt-4 pt-4 border-t">
                    <button onclick="downloadSample()" class="bg-green-600 text-white px-4 py-2 rounded text-sm">📥 Download Sample VCF</button>
                </div>
            </div>

            <div id="single-mode" class="hidden bg-green-50 p-6 rounded-lg">
                <select id="patient-select" class="w-full p-3 border-2 rounded mb-3"></select>
                <button onclick="analyzeSingle()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">🧬 Analyze</button>
            </div>

            <div id="batch-mode" class="hidden bg-purple-50 p-6 rounded-lg">
                <div id="patient-checks" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto mb-4"></div>
                <div class="flex gap-3">
                    <button onclick="selectAll()" class="bg-gray-600 text-white px-4 py-2 rounded">✓ All</button>
                    <button onclick="analyzeBatch()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold flex-1">🚀 Analyze</button>
                </div>
            </div>
        </div>

        <div id="loading" class="hidden bg-blue-100 p-4 rounded-lg mb-6">
            <p class="text-blue-800 font-semibold animate-pulse">⚙️ Processing...</p>
        </div>

        <div id="stats" class="hidden mb-6">
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-blue-600 text-white p-4 rounded-lg"><p class="text-xs">PATIENTS</p><p class="text-4xl font-bold" id="stat-patients">0</p></div>
                <div class="bg-red-600 text-white p-4 rounded-lg"><p class="text-xs">PATHOGENIC</p><p class="text-4xl font-bold" id="stat-pathogenic">0</p></div>
                <div class="bg-green-600 text-white p-4 rounded-lg"><p class="text-xs">THERAPIES</p><p class="text-4xl font-bold" id="stat-therapies">0</p></div>
                <div class="bg-purple-600 text-white p-4 rounded-lg"><p class="text-xs">TIME</p><p class="text-4xl font-bold" id="stat-time">0s</p></div>
            </div>
        </div>

        <div id="results"></div>

        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <div class="bg-blue-600 text-white p-6 flex justify-between items-center sticky top-0">
                    <h2 class="text-3xl font-bold">Clinical Report</h2>
                    <button onclick="closeModal()" class="text-3xl font-bold">&times;</button>
                </div>
                <div id="modal-content" class="p-8"></div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://barabara-nonconfirmatory-protectingly.ngrok-free.app';
        let allData = [];
        
        const patients = [
            {id: 'PT-001', name: 'Sarah M.', age: 42, ancestry: 'European', indication: 'Family history breast cancer'},
            {id: 'PT-002', name: 'Wei L.', age: 35, ancestry: 'East Asian', indication: 'Early onset cancer'},
            {id: 'PT-003', name: 'Jamal K.', age: 61, ancestry: 'African American', indication: 'Lung cancer'},
            {id: 'PT-004', name: 'Carlos M.', age: 45, ancestry: 'Hispanic/Latinx', indication: 'Colorectal cancer'},
            {id: 'PT-005', name: 'Priya S.', age: 52, ancestry: 'South Asian', indication: 'Breast cancer'},
            {id: 'PT-006', name: 'Mohammed A.', age: 67, ancestry: 'Middle Eastern', indication: 'Prostate cancer'},
            {id: 'PT-007', name: 'Jennifer P.', age: 38, ancestry: 'European', indication: 'Ovarian cancer'},
            {id: 'PT-008', name: 'Kenji T.', age: 55, ancestry: 'East Asian', indication: 'Gastric cancer'},
            {id: 'PT-009', name: 'Emily R.', age: 29, ancestry: 'European', indication: 'Hereditary cancer'},
            {id: 'PT-010', name: 'John D.', age: 58, ancestry: 'European', indication: 'Lynch syndrome'}
        ];

        window.onload = () => {
            const sel = document.getElementById('patient-select');
            patients.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.name} - ${p.ancestry}`;
                sel.appendChild(opt);
            });

            const checks = document.getElementById('patient-checks');
            patients.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-2 border rounded';
                div.innerHTML = `<input type="checkbox" id="c-${p.id}" value="${p.id}" class="w-4 h-4"><label for="c-${p.id}" class="text-sm"><b>${p.name}</b> - ${p.ancestry}</label>`;
                checks.appendChild(div);
            });
        };

        function showMode(mode) {
            ['upload-mode', 'single-mode', 'batch-mode'].forEach(m => document.getElementById(m).classList.add('hidden'));
            document.getElementById(mode + '-mode').classList.remove('hidden');
        }

        function selectAll() {
            document.querySelectorAll('#patient-checks input').forEach(cb => cb.checked = true);
        }

        function downloadSample() {
            const vcf = `##fileformat=VCFv4.2\n#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\nchr17\t43044295\t.\tT\tC\t55.0\tPASS\tGENE=BRCA1;CONSEQUENCE=missense_variant;AF=0.0001`;
            const blob = new Blob([vcf], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'sample.vcf';
            a.click();
        }

        async function analyzeUpload() {
            const file = document.getElementById('vcf-upload').files[0];
            if (!file) { alert('Select a file'); return; }

            const formData = new FormData();
            formData.append('file', file);
            document.getElementById('loading').classList.remove('hidden');

            try {
                const r1 = await fetch(`${API}/api/upload-vcf`, {method: 'POST', body: formData});
                const d1 = await r1.json();
                const r2 = await fetch(`${API}/api/analyze-batch`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.variants})
                });
                const d2 = await r2.json();
                document.getElementById('loading').classList.add('hidden');
                displayResults(d2, 1, '0.5', [{id: 'UP-001', name: document.getElementById('patient-name').value || 'Upload', age: '?', ancestry: 'Unknown', indication: 'VCF Upload'}]);
            } catch (e) {
                document.getElementById('loading').classList.add('hidden');
                alert('Error: ' + e.message);
            }
        }

        async function analyzeSingle() {
            const id = document.getElementById('patient-select').value;
            if (!id) { alert('Select a patient'); return; }

            document.getElementById('loading').classList.remove('hidden');

            try {
                const r1 = await fetch(`${API}/api/sample-data`);
                const d1 = await r1.json();
                const r2 = await fetch(`${API}/api/analyze-batch`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.sample_variants.slice(0, 5)})
                });
                const d2 = await r2.json();
                document.getElementById('loading').classList.add('hidden');
                displayResults(d2, 1, '0.5', [patients.find(p => p.id === id)]);
            } catch (e) {
                document.getElementById('loading').classList.add('hidden');
                alert('Error: ' + e.message);
            }
        }

        async function analyzeBatch() {
            const ids = Array.from(document.querySelectorAll('#patient-checks input:checked')).map(cb => cb.value);
            if (ids.length === 0) { alert('Select patients'); return; }

            document.getElementById('loading').classList.remove('hidden');
            const start = Date.now();

            try {
                const r1 = await fetch(`${API}/api/sample-data`);
                const d1 = await r1.json();
                const r2 = await fetch(`${API}/api/analyze-batch`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({variants: d1.sample_variants})
                });
                const d2 = await r2.json();
                const time = ((Date.now() - start) / 1000).toFixed(2);
                document.getElementById('loading').classList.add('hidden');
                displayResults(d2, ids.length, time, patients.filter(p => ids.includes(p.id)));
            } catch (e) {
                document.getElementById('loading').classList.add('hidden');
                alert('Error: ' + e.message);
            }
        }

        function displayResults(data, count, time, pts) {
            const anns = data.annotations;
            const perPatient = Math.ceil(anns.length / count);
            const pathCount = anns.filter(a => a.ml_classification.classification.includes('Pathogenic')).length;
            const therapyCount = anns.filter(a => a.pharmacogenomics.drugs && a.pharmacogenomics.drugs.length > 0 && a.pharmacogenomics.drugs[0] !== 'Clinical trial consideration').length;

            document.getElementById('stat-patients').textContent = count;
            document.getElementById('stat-pathogenic').textContent = pathCount;
            document.getElementById('stat-therapies').textContent = therapyCount;
            document.getElementById('stat-time').textContent = time + 's';
            document.getElementById('stats').classList.remove('hidden');

            allData = [];
            for (let i = 0; i < count; i++) {
                const pVars = anns.slice(i * perPatient, (i + 1) * perPatient);
                const path = pVars.filter(a => a.ml_classification.classification.includes('Pathogenic'));
                
                const treats = new Map();
                path.forEach(a => {
                    if (a.pharmacogenomics.drugs && a.pharmacogenomics.drugs.length > 0 && a.pharmacogenomics.drugs[0] !== 'Clinical trial consideration') {
                        treats.set(a.variant.gene, {drugs: a.pharmacogenomics.drugs, indication: a.pharmacogenomics.indication});
                    }
                });

                const diseases = new Set();
                path.forEach(a => {
                    const d = a.disease_association.diseases[0];
                    if (d && d !== 'Unknown/Not in database') diseases.add(d);
                });

                allData.push({patient: pts[i], variants: pVars, pathCount: path.length, treatments: treats, diseases: Array.from(diseases)});
            }

            let html = '<div class="space-y-6">';

            allData.forEach((r, idx) => {
                const priority = r.pathCount > 0 ? 'border-red-400 bg-red-50' : 'border-gray-300 bg-white';
                const badge = r.pathCount > 0 ? '<span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">HIGH PRIORITY</span>' : '<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">NEGATIVE</span>';

                html += `
                    <div class="border-2 ${priority} rounded-lg shadow-lg p-6">
                        <div class="flex justify-between mb-4">
                            <div>
                                <h3 class="text-2xl font-bold">${r.patient.name}</h3>
                                <p class="text-sm text-gray-600">${r.patient.id} | ${r.patient.age}y | ${r.patient.ancestry}</p>
                            </div>
                            ${badge}
                        </div>

                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div class="bg-white p-3 rounded border"><p class="text-xs">Variants</p><p class="text-2xl font-bold">${r.variants.length}</p></div>
                            <div class="bg-white p-3 rounded border"><p class="text-xs">Pathogenic</p><p class="text-2xl font-bold text-red-600">${r.pathCount}</p></div>
                            <div class="bg-white p-3 rounded border"><p class="text-xs">Therapies</p><p class="text-2xl font-bold text-green-600">${r.treatments.size}</p></div>
                            <div class="bg-white p-3 rounded border"><p class="text-xs">Time</p><p class="text-2xl font-bold text-blue-600">${(parseFloat(time)/count).toFixed(2)}s</p></div>
                        </div>

                        ${r.diseases.length > 0 ? `
                            <div class="bg-white p-4 rounded border-2 border-red-300 mb-3">
                                <p class="font-bold text-red-800 mb-2">🩺 Disease Risk:</p>
                                ${r.diseases.map(d => `<p class="text-sm text-red-700">• ${d}</p>`).join('')}
                            </div>
                        ` : ''}

                        ${r.treatments.size > 0 ? `
                            <div class="bg-white p-4 rounded border-2 border-green-300 mb-3">
                                <p class="font-bold text-green-800 mb-2">💊 Precision Therapies:</p>
                                ${Array.from(r.treatments).map(([g, t]) => `<p class="text-sm"><strong>${g}:</strong> ${t.drugs.join(', ')}</p>`).join('')}
                            </div>
                        ` : ''}

                        <details class="bg-white p-4 rounded border mb-3">
                            <summary class="font-bold cursor-pointer">📊 All ${r.variants.length} Variants</summary>
                            <div class="mt-3 space-y-2 max-h-64 overflow-y-auto">
                                ${r.variants.map(v => {
                                    const c = v.ml_classification.classification;
                                    let col = 'bg-gray-100';
                                    if (c === 'Pathogenic') col = 'bg-red-100 border-red-300';
                                    else if (c === 'Likely Pathogenic') col = 'bg-orange-100 border-orange-300';
                                    return `<div class="${col} border p-3 rounded text-sm"><div class="flex justify-between"><b>${v.variant.gene}</b><span>${c}</span></div><p class="text-xs">${v.variant.id}</p></div>`;
                                }).join('')}
                            </div>
                        </details>

                        <button onclick="showReport(${idx})" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold">📋 Full Report</button>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('results').innerHTML = html;
        }

        function showReport(idx) {
            const r = allData[idx];
            let html = `
                <div class="mb-6 bg-gray-50 p-4 rounded">
                    <h3 class="text-2xl font-bold mb-3">Patient</h3>
                    <p><strong>Name:</strong> ${r.patient.name}</p>
                    <p><strong>Ancestry:</strong> ${r.patient.ancestry}</p>
                </div>
                <div><h3 class="text-2xl font-bold mb-3">All Variants</h3><div class="space-y-3">
            `;
            
            r.variants.forEach(v => {
                const c = v.ml_classification.classification;
                let col = 'bg-gray-50';
                if (c === 'Pathogenic') col = 'bg-red-50';
                
                html += `
                    <div class="${col} border-2 p-4 rounded">
                        <div class="flex justify-between mb-2"><b class="text-xl">${v.variant.gene}</b><span>${c}</span></div>
                        <p class="text-sm">${v.variant.id}</p>
                        <p class="text-sm">${v.variant.consequence} | AF: ${v.variant.allele_frequency.toFixed(4)}</p>
                        <p class="text-sm text-gray-700 mt-2">${v.ml_classification.clinical_significance}</p>
                        ${v.pharmacogenomics.drugs.length > 0 ? `<div class="mt-2 bg-green-100 p-3 rounded"><p class="font-semibold text-green-800">💊 ${v.pharmacogenomics.drugs.join(', ')}</p></div>` : ''}
                    </div>
                `;
            });
            
            html += '</div></div>';
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }
    </script>
</body>
</html>
